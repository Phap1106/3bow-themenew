// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model EmailLoginChallenge {
  id          String   @id @default(cuid())
  userId      String
  token       String   @default("")
  codeHash    String
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
  lastSentAt  DateTime  @default(now())
  sentCount   Int       @default(0)
  verifyCount Int       @default(0)
  ip          String?
  userAgent   String?
  nextPath    String?
  user        User      @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
}


model Article {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  excerpt     String?
  content     String?
  author      String?
  publishedAt DateTime?
  image       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([publishedAt])
}

enum UserRole {
  ADMIN
  SUPPORT_ADMIN
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  firstName String?
  lastName  String?
  phone     String?
  birthday  DateTime?
  address   String?
  role      UserRole  @default(SUPPORT_ADMIN)
  session   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  sessionVersion Int @default(0)

  @@index([role])

  
  emailVerified       DateTime? // nếu muốn verify one-time
  lockedUntil         DateTime?
  loginAttemptCount   Int       @default(0)
  lastLoginAttemptAt  DateTime?

  challenges EmailLoginChallenge[]
}

/**
 * ====== PHẦN THÊM MỚI (KHÔNG CHẠM VÀO MODEL CŨ) ======
 */

/// Dịch vụ khách quan tâm (mapping thẳng từ form)
enum ServiceType {
  SEO
  GOOGLE_ADS
  FACEBOOK_INSTAGRAM_ADS
  TIKTOK_ADS
  LANDING_TRACKING
  OTHER
}

/// Khoảng ngân sách (mapping thẳng từ form)
enum BudgetRange {
  LT_50M // < 50 triệu/tháng
  B_50_150M // 50–150 triệu/tháng
  B_150_300M // 150–300 triệu/tháng
  GT_300M // > 300 triệu/tháng
  UNKNOWN
}

/// Trạng thái xử lý lead
enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  WON
  LOST
  SPAM
  ARCHIVED
}

/// Kênh tạo lead
enum LeadChannel {
  WEBSITE
  LANDINGPAGE
  PHONE
  EMAIL
  CHAT
  OTHER
}

model Lead {
  id String @id @default(cuid())

  name        String
  phone       String
  email       String?
  url         String?
  service     ServiceType?
  serviceText String?
  budget      BudgetRange?
  note        String?
  consent     Boolean      @default(false)

  status  LeadStatus  @default(NEW)
  channel LeadChannel @default(WEBSITE)

  // KHÔNG khai báo relation, chỉ lưu id
  assignedToId String?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  referrer    String?
  pagePath    String?
  ip          String?
  userAgent   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
  @@index([email])
  @@index([status])
  @@index([createdAt])
}
